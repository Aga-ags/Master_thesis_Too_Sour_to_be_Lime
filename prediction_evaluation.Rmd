---
title: "Prediction evaluation"
author: "Agnieszka Kubica"
date: "`r Sys.Date()`"
output: html_document
---

```{r}
library(tidyverse)
```

# Load data

```{r load_data}
# pH only
df_pH <- read.csv(file="./tuning_results/predictions_validation_pH_weights.csv")
df_pH

df_long_pH <- df_pH %>%
  pivot_longer(
    cols = contains("pH") & !matches("^pH$"),  # all columns with "pH" except exactly "pH"
    names_to = "model",
    values_to = "predicted_pH"
  )

df_long_pH$model <- ordered(df_long_pH$model, levels =c("pH_only_H2O", "pH_pH_imp", "pH_H20_and_lime_6", "pH_imp_and_lime_65", "pH_imp_and_lime_65_0_2", "pH_full_imp"))
df_long_pH

df_pH_test <- read.csv(file="./tuning_results/predictions_test_pH_weights.csv")
df_pH_test

df_long_pH_test <- df_pH_test %>%
  pivot_longer(
    cols = contains("pH") & !matches("^pH$"),  # all columns with "pH" except exactly "pH"
    names_to = "model",
    values_to = "predicted_pH"
  )

df_long_pH_test$model <- ordered(df_long_pH_test$model, levels =c("pH_only_H2O", "pH_pH_imp", "pH_H20_and_lime_6", "pH_imp_and_lime_65", "pH_imp_and_lime_65_0_2", "pH_full_imp"))
df_long_pH_test


# lime only
df_lime_and_both <- read.csv(file="./tuning_results/predictions_validation_lime_and_both_weights.csv")
df_lime_and_both

df_long_lime <- df_lime_and_both %>%
  pivot_longer(
    cols = 3:8, 
    names_to = "model",
    values_to = "predicted_lime"
  )|>
  select("lime", "model", "predicted_lime")
df_long_lime$model <- ordered(df_long_lime$model, levels =c("lime_only_H2O", "lime_pH_imp", "lime_H20_and_lime_65", "lime_imp_and_lime_65", "lime_imp_and_lime_65_0_2", "lime_full_imp"))
df_long_lime


df_long_both_pH <- df_lime_and_both |>
  select(! 3:8)|>
  pivot_longer(
    cols = matches("pH$") & contains("both"),
    names_to = c("model"),
    values_to = "predicted_pH",
    names_pattern = "(.*)pH")|>
  select("pH", "model", "predicted_pH")

df_long_both_pH$model <- ordered(df_long_both_pH$model, levels =c("both_only_H2O", "both_pH_imp", "both_H20_and_lime_65", "both_imp_and_lime_65", "both_imp_and_lime_65_0_2", "both_full_imp"))
df_long_both_pH


df_long_both_lime <- df_lime_and_both |>
  select(! 3:8)|>
  pivot_longer(
    cols = matches("lime$") & contains("both"),
    names_to = c("model"),
    values_to = "predicted_lime",
    names_pattern = "(.*)lime")|>
  select("lime", "model", "predicted_lime")


df_long_both_lime$model <- ordered(df_long_both_lime$model, levels =c("both_only_H2O", "both_pH_imp", "both_H20_and_lime_65", "both_imp_and_lime_65", "both_imp_and_lime_65_0_2", "both_full_imp"))
df_long_both_lime


# pH no weights
df_pH_no_weights <- read.csv(file="./tuning_results/predictions_validation_ph_no_weights.csv")
df_pH_no_weights

df_long_pH_no_weights <- df_pH_no_weights %>%
  pivot_longer(
    cols = contains("pH") & !matches("^pH$"),  # all columns with "pH" except exactly "pH"
    names_to = "model",
    values_to = "predicted_pH"
  )

df_long_pH_no_weights$model <- ordered(df_long_pH_no_weights$model, levels =c("pH_no_weights_only_H2O", "pH_no_weights_pH_imp", "pH_no_weights_H20_and_lime_65", "pH_no_weights_imp_and_lime_65", "pH_no_weights_imp_and_lime_65_0_2", "pH_no_weights_full_imp"))
df_long_pH_no_weights


# dropout pH:
df_pH_dropout <- read.csv(file="./tuning_results/predictions_validation_dropout.csv")
df_pH_dropout

df_long_pH_dropout <- df_pH_dropout %>%
  pivot_longer(
    cols = contains("pH") & !matches("^pH$"),  # all columns with "pH" except exactly "pH"
    names_to = "model",
    values_to = "predicted_pH"
  )

df_long_pH_dropout$model <- ordered(df_long_pH_dropout$model, levels =c("pH_dropout_only_H2O", "pH_dropout_pH_imp", "pH_dropout_H20_and_lime_65", "pH_dropout_imp_and_lime_65", "pH_dropout_imp_and_lime_65_0_2", "pH_dropout_full_imp"))
df_long_pH_dropout

df_pH_dropout_test <- read.csv(file="./tuning_results/predictions_test_dropout.csv")

df_long_pH_dropout_test <- df_pH_dropout_test %>%
  pivot_longer(
    cols = contains("pH") & !matches("^pH$"),  # all columns with "pH" except exactly "pH"
    names_to = "model",
    values_to = "predicted_pH"
  )

df_long_pH_dropout_test$model <- ordered(df_long_pH_dropout_test$model, levels =c("pH_dropout_only_H2O", "pH_dropout_pH_imp", "pH_dropout_H20_and_lime_65", "pH_dropout_imp_and_lime_65", "pH_dropout_imp_and_lime_65_0_2", "pH_dropout_full_imp"))
df_long_pH_dropout_test


```


# Perform data evaluation 

```{r}
metrics_by_model <-function(df_long, observed_column, predicted_column){
  observed_col <- enquo(observed_column)
  predicted_col <- enquo(predicted_column)
  
  df_long %>%
    group_by(model) %>%
    summarise(
      MAE  = mean(abs(!!observed_col - !!predicted_col), na.rm = TRUE),
      MSE  = mean((!!observed_col - !!predicted_col)^2, na.rm = TRUE),
      RMSE = sqrt(mean((!!observed_col - !!predicted_col)^2, na.rm = TRUE)),
      R2   = 1 - sum((!!observed_col - !!predicted_col)^2, na.rm = TRUE) / sum((!!observed_col - mean(!!observed_col, na.rm = TRUE))^2, na.rm = TRUE)
    )
}
```

```{r}


pH_metrics <- metrics_by_model(df_long_pH, observed_column = pH, predicted_column = predicted_pH)
pH_metrics

lime_metrics <- metrics_by_model(df_long_lime, observed_column = lime, predicted_column = predicted_lime)
lime_metrics

lime_metrics_both <- metrics_by_model(df_long_both_pH, observed_column = pH, predicted_column = predicted_pH)
lime_metrics_both

lime_metrics_both <- metrics_by_model(df_long_both_lime, observed_column = lime, predicted_column = predicted_lime)
lime_metrics_both

pH_dropout_metrics <- metrics_by_model(df_long_pH_dropout, observed_column = pH, predicted_column = predicted_pH)
pH_dropout_metrics

pH_dropout_metrics_test <- metrics_by_model(df_long_pH_dropout_test, observed_column = pH, predicted_column = predicted_pH)
pH_dropout_metrics_test

pH_metrics_test <- metrics_by_model(df_long_pH_test, observed_column = pH, predicted_column = predicted_pH)
pH_metrics_test


pH_dropout_metrics <- metrics_by_model(df_long_pH_dropout, observed_column = pH, predicted_column = predicted_pH)
pH_dropout_metrics



pH_no_weights_metrics <- metrics_by_model(df_long_pH_no_weights, observed_column = pH, predicted_column = predicted_pH)
pH_no_weights_metrics

```





```{r observed_vs_predicted_plot}
ggplot(df_long_pH, aes(x = pH, y = predicted_pH)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  facet_wrap(~ model) +
  labs(
    title = "Relationship between observed and predicted pH values",
    x = "Actual pH",
    y = "Predicted pH"
  ) +
  theme_minimal()


ggplot(df_long_lime, aes(x = lime, y = predicted_lime)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  facet_wrap(~ model) +
  labs(
    title = "Relationship between observed and predicted pH values",
    x = "Actual pH",
    y = "Predicted pH"
  ) +
  theme_minimal()

```

```{r studying_residuals}
df$residuals <- df$pH - df$pH_only_H2O

ggplot(df, aes(x = pH_only_H2O, y = residuals)) +
  geom_point(color = "darkorange2") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(title = "Residuals vs Fitted", x = "Predicted", y = "Residuals") +
  theme_minimal()

ggplot(df, aes(x = residuals)) +
  geom_histogram(bins = 30, fill = "darkorange2",color = "black") +
  labs(title = "Histogram of Residuals", x = "Residual", y = "Count") +
  theme_minimal()




```


```{r comaprison_of_y_distribution}
# Is the double peak pH structure preserved?

ggplot(df, aes(x = pH))+
  geom_histogram(bins = 20)


ggplot(df, aes(x = pH_try_run))+
  geom_histogram(bins = 20)

ggplot(df, aes(x = pH_and_lime_try_runpH))+
  geom_histogram(bins = 20)


ggplot(df, aes(x = lime))+
  geom_histogram(bins = 20)

ggplot(df, aes(x = pH_and_lime_try_runlime))+
  geom_histogram(bins = 20)

```


# Inference
```{r predictor_importance}

```

```{r responce_plots}
# responce curves, distribution of one against the other??

```


```{r rotated_axis_plot}

```




# Objective function experiment

```{r load_data_objective_exp}
df_objective_val <- read.csv(file="./tuning_results/predictions_validation_experiments.csv")
df_objective_test <- read.csv(file="./tuning_results/predictions_test_experiments.csv")
df_objective_val
```
```{r}
pivot_to_pred_model <- function(df){
  df |>
  pivot_longer(
    cols = -c(1:2),
    names_pattern = "(pH|lime)_(.*)$",
    names_to = c("predicted", "model"))
}

plot_observed_against_predicted <- function(df){
  
}
```


```{r}


df_long_objective_val <- pivot_to_pred_model(df_objective_val)
df_long_objective_val

df_long_objective_test <- pivot_to_pred_model(df_objective_test)
df_long_objective_test
```
```{r}
df_long_objective_val|>
  filter(predicted == "pH")|>
metrics_by_model(pH, value)

df_long_objective_val|>
  filter(predicted == "lime")|>
metrics_by_model(lime, value)

df_long_objective_val|>
  filter(predicted == "pH")|>
ggplot(aes(x = pH, y = value)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  facet_wrap(~ model) +
  labs(
    title = "Relationship between observed and predicted pH values",
    x = "Actual pH",
    y = "Predicted pH"
  ) +
  theme_minimal()
```

