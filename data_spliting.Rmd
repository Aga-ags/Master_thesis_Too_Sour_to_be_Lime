---
title: "pH ANN"
author: "Agnieszka Kubica"
date: "`r Sys.Date()`"
output: html_document
---



```{r libraries}
library(terra)
library(dplyr)
library(sf)
library(tableone)
library(recipes)
set.seed(114)
```

# Load data 
```{r load_data}
df <- readRDS(file="../data/processed_data.Rda")
df
```
## Make sample weights
```{r}
df <- df |>
  mutate(sample_weight = ifelse(pH_origin == "site", 0.7, ifelse(pH_origin == "CaCl2", 1, 0.9)),
          sample_weight = ifelse(lime_imputed == TRUE, sample_weight-0.1, sample_weight),
         sample_weight = ifelse(lime_imputed_3_5 == TRUE, sample_weight-0.2, sample_weight))
```


## One code encoding for categorical 
```{r}
recipe_obj <- recipe(~ ., data = df) %>%
  step_dummy(all_nominal() &!any_of(c("pH_origin", "lime_imputed", "lime_imputed_3_5", "lime_imputed_0_2")), one_hot = TRUE) %>%
  prep()

one_hot_df <- bake(recipe_obj, new_data = NULL)
one_hot_df
```


## Split data
```{r}
# extract sites:
df_sites <- one_hot_df|>
  dplyr::select("x", "y")|>
  unique()
print("Number of sites")
nrow(df_sites)

# find which sites contain 
imputed_sites <- one_hot_df |>
  dplyr::select("x", "y", "pH_origin", "lime_imputed")|>
  filter(pH_origin %in% c("site", "H2O") | lime_imputed == TRUE)|>
  dplyr::select("x", "y")|>
  unique()
imputed_sites

# find which sites are fully observed from certain data
observed_sites <- dplyr::anti_join(df_sites, imputed_sites, by = c("x", "y"))
observed_sites


# find percentage to sample the not imputed data to equal to 20 perc of entire site sample
sample_10 <- 0.1 * nrow(df_sites)
amount_of_non_imputed_equal_to_10_perc <- sample_10/ nrow(observed_sites)
amount_of_non_imputed_equal_to_10_perc


# testing and validation datasets 
# extract sites:
test_and_validation_sites <- observed_sites %>%   
  dplyr::sample_frac(amount_of_non_imputed_equal_to_10_perc)
print("Numer of validation and test sites:")
nrow(test_and_validation_sites)

validation_sites <- test_and_validation_sites %>% dplyr::sample_frac(0.50)
print("Numer of validation sites:")
nrow(validation_sites)

test_sites <- dplyr::anti_join(test_and_validation_sites, validation_sites, by = c("x", "y"))
print("Numer of test sites:")
nrow(test_sites)


#subset dataframe
validation <- dplyr::inner_join(one_hot_df, validation_sites, by = c("x", "y"))
print("Numer of validation horizons:")
nrow(validation)

test <- dplyr::inner_join(one_hot_df, test_sites, by = c("x", "y"))
print("Numer of test horizons:")
nrow(test)

# remaining df creates the train df: 
train  <- dplyr::anti_join(one_hot_df, test_and_validation_sites, by = c("x", "y"))
print("Numer of train horizons:")
nrow(train)

# rejoin the data into a single dataframe with indication of split:
df_1 <- train |>
  mutate(split = "Train")
df_2 <- validation |>
  mutate(split = "Validation")
df_3 <- test |>
  mutate(split = "Test")

df <- rbind(df_1, df_2, df_3)
```


## Investigate the representatives of test sample:
```{r}
df_all_samples_arable <- readRDS(file="../data/arable_samples_all.Rda")|>
  st_as_sf(coords = c("x", "y"), crs = 2056)

test_sf <- st_as_sf(test, coords = c("x", "y"), crs = 2056)  
train_sf <- st_as_sf(train, coords = c("x", "y"), crs = 2056)
validation_sf <- st_as_sf(validation, coords = c("x", "y"), crs = 2056)
df_sf <- st_as_sf(df, coords = c("x", "y"), crs = 2056)

plot(st_geometry(df_all_samples_arable), col = 'grey', main = "Data splits spatial distribution")
plot(st_geometry(train_sf), col = 'blue', add = TRUE)
plot(st_geometry(test_sf), col = 'red', add = TRUE)
plot(st_geometry(validation_sf), col = 'yellow', add = TRUE)
legend("bottomright", legend = c("All", "Train", "Test", "Validation"), col = c("grey", "blue", "red", "yellow"), pch = 1)

```

```{r}
areable_land_raster <- terra::rast("../data/zh_arable_land_s3.tif")
crs(areable_land_raster)  <- "epsg:2056"
```

```{r}
plot(areable_land_raster,      
     breaks = c(-0.5,0.5,1.5), 
     col = c("white", "black"))
plot(st_geometry(test_sf), col = 'red',  pch = 16, add = TRUE)

plot(areable_land_raster,      
     breaks = c(-0.5,0.5,1.5), 
     col = c("white", "black"))
plot(st_geometry(train_sf), col = 'red',  pch = 16, add = TRUE)

plot(areable_land_raster,      
     breaks = c(-0.5,0.5,1.5), 
     col = c("white", "black"))
plot(st_geometry(validation_sf), col = 'red',  pch = 16, add = TRUE)

plot(areable_land_raster,      
     breaks = c(-0.5,0.5,1.5), 
     col = c("white", "black"))
plot(st_geometry(test_sf), col = 'red',  pch = 16, add = TRUE)
plot(st_geometry(validation_sf), col = 'green',  pch = 16, add = TRUE)

plot(areable_land_raster,      
     breaks = c(-0.5,0.5,1.5), 
     col = c("white", "black"))
observed_sites|>
  st_as_sf(coords = c("x", "y"), crs = 2056) |>
    plot(col = 'red',  pch = 16, add = TRUE)
  
```

```{r}
columns <- df|>
  dplyr::select(-"x", -"y", - "split")|>
  colnames()
CreateTableOne(vars =columns, strata = "split", data = df)
```


# Save prepared data
```{r}
x_train <- train|>
  dplyr::select(!c("pH", "pH_origin", "x", "y", "sample_weight", "lime", "lime_imputed", "lime_imputed_0_2", "lime_imputed_3_5"))|>
  as.matrix()
y_train <- train|>
  dplyr::select("pH", "lime")

x_valid <- validation|>
  dplyr::select(!c("pH", "pH_origin", "x", "y", "sample_weight", "lime", "lime_imputed", "lime_imputed_0_2", "lime_imputed_3_5"))|>
  as.matrix()
y_valid  <- validation|>
  dplyr::select("pH", "lime")

x_test <- test|>
  dplyr::select(!c("pH", "pH_origin", "x", "y", "sample_weight", "lime", "lime_imputed", "lime_imputed_0_2", "lime_imputed_3_5"))|>
  as.matrix()
y_test  <- test |>
  dplyr::select("pH", "lime")

```


```{r}
train |> count(pH_origin, lime_imputed, sort = TRUE)
```





```{r}
# Select training data based on imputation conditions
x_tain_only_H20 <- train|>
  filter(lime_imputed == FALSE & pH_origin != "site")|>
  dplyr::select(!c("pH", "pH_origin", "x", "y",   "sample_weight", "lime", "lime_imputed", "lime_imputed_0_2", "lime_imputed_3_5"))|>
  as.matrix()
y_tain_only_H20 <- train|>
  filter(lime_imputed == FALSE & pH_origin != "site")|>
  dplyr::select("pH", "lime")

x_tain_pH_imp <- train|>
  filter(lime_imputed == FALSE)|>
  dplyr::select(!c("pH", "pH_origin", "x", "y",   "sample_weight", "lime", "lime_imputed", "lime_imputed_0_2", "lime_imputed_3_5"))|>
  as.matrix()
y_tain_pH_imp<- train|>
   filter(lime_imputed == FALSE)|>
  dplyr::select("pH", "lime")

x_tain_H20_and_lime_65<- train|>
  filter(lime_imputed_0_2 == FALSE & lime_imputed_3_5 == FALSE & pH_origin != "site")|>
  dplyr::select(!c("pH", "pH_origin", "x", "y",   "sample_weight", "lime", "lime_imputed", "lime_imputed_0_2", "lime_imputed_3_5"))|>
  as.matrix()
y_tain_H20_and_lime_65<- train|>
  filter(lime_imputed_0_2 == FALSE & lime_imputed_3_5 == FALSE & pH_origin != "site")|>
  dplyr::select("pH", "lime")

x_tain_pH_imp_and_lime_65<- train|>
  filter(lime_imputed_0_2 == FALSE & lime_imputed_3_5 == FALSE)|>
  dplyr::select(!c("pH", "pH_origin", "x", "y",   "sample_weight", "lime", "lime_imputed", "lime_imputed_0_2", "lime_imputed_3_5"))|>
  as.matrix()
y_tain_pH_imp_and_lime_65<- train|>
  filter(lime_imputed_0_2 == FALSE & lime_imputed_3_5 == FALSE)|>
  dplyr::select("pH", "lime")

x_tain_pH_imp_and_lime_65_0_2<- train|>
  filter(lime_imputed_3_5 == FALSE)|>
  dplyr::select(!c("pH", "pH_origin", "x", "y",   "sample_weight", "lime", "lime_imputed", "lime_imputed_0_2", "lime_imputed_3_5"))|>
  as.matrix()
y_tain_pH_imp_and_lime_65_0_2<- train|>
  filter(lime_imputed_3_5 == FALSE)|>
  dplyr::select("pH", "lime")
```

```{r}
nrow(x_train)
nrow(x_tain_only_H20)
nrow(x_tain_pH_imp)
nrow(x_tain_H20_and_lime_65)
nrow(x_tain_pH_imp_and_lime_65)
nrow(x_tain_pH_imp_and_lime_65_0_2)
```


```{r}
write.csv(x_train,file='../data/x_train_full_imp.csv', row.names=FALSE)
write.csv(y_train,file='../data/y_train_full_imp.csv', row.names=FALSE)

write.csv(x_tain_only_H20,file='../data/x_train_only_H20.csv', row.names=FALSE)
write.csv(y_tain_only_H20,file='../data/y_train_only_H20.csv', row.names=FALSE)


write.csv(x_tain_pH_imp,file='../data/x_train_pH_imp.csv', row.names=FALSE)
write.csv(y_tain_pH_imp,file='../data/y_train_pH_imp.csv', row.names=FALSE)


write.csv(x_tain_H20_and_lime_65,file='../data/x_train_H20_and_lime_65.csv', row.names=FALSE)
write.csv(y_tain_H20_and_lime_65,file='../data/y_train_H20_and_lime_65.csv', row.names=FALSE)


write.csv(x_tain_pH_imp_and_lime_65,file='../data/x_train_pH_imp_and_lime_65.csv', row.names=FALSE)
write.csv(y_tain_pH_imp_and_lime_65,file='../data/y_train_pH_imp_and_lime_65.csv', row.names=FALSE)


write.csv(x_tain_pH_imp_and_lime_65_0_2,file='../data/x_train_pH_imp_and_lime_65_0_2.csv', row.names=FALSE)
write.csv(y_tain_pH_imp_and_lime_65_0_2,file='../data/y_train_pH_imp_and_lime_65_0_2.csv', row.names=FALSE)


write.csv(x_valid,file='../data/x_valid.csv', row.names=FALSE)
write.csv(y_valid,file='../data/y_valid.csv', row.names=FALSE)

write.csv(x_test,file='../data/x_test.csv', row.names=FALSE)
write.csv(y_test,file='../data/y_test.csv', row.names=FALSE)
```

## Save training weights
```{r}
sample_wight_full_imp <- train|>
  dplyr::select("sample_weight")

write.csv(sample_wight_full_imp,file='../data/sample_weights_full_imp.csv', row.names=FALSE)


sample_wight_only_H20 <- train|>
  filter(lime_imputed == FALSE & pH_origin != "site")|>
  dplyr::select("sample_weight")

write.csv(sample_wight_only_H20,file='../data/sample_weights_only_H20.csv', row.names=FALSE)

sample_wight_pH_imp <- train|>
  filter(lime_imputed == FALSE)|>
  dplyr::select("sample_weight")
write.csv(sample_wight_pH_imp,file='../data/sample_weights_pH_imp.csv', row.names=FALSE)


sample_wight_H20_and_lime_65<- train|>
  filter(lime_imputed_0_2 == FALSE & lime_imputed_3_5 == FALSE & pH_origin != "site")|>
  dplyr::select("sample_weight")

write.csv(sample_wight_H20_and_lime_65,file='../data/sample_weights_H20_and_lime_65.csv', row.names=FALSE)

sample_wight_pH_imp_and_lime_65<- train|>
  filter(lime_imputed_0_2 == FALSE & lime_imputed_3_5 == FALSE)|>
  dplyr::select("sample_weight")

write.csv(sample_wight_pH_imp_and_lime_65,file='../data/sample_weights_pH_imp_and_lime_65.csv', row.names=FALSE)

sample_wight_pH_imp_and_lime_65_0_2<- train|>
  filter(lime_imputed_3_5 == FALSE)|>
  dplyr::select("sample_weight")

write.csv(sample_wight_pH_imp_and_lime_65_0_2,file='../data/sample_weights_pH_imp_and_lime_65_0_2.csv', row.names=FALSE)
```


